# Replay System Testing Guide

## Implementation Summary

The Simulation Replay System has been implemented with the following components:

### New Files Created

1. **Assets/Scripts/Replay/SimulationLogParser.cs** - Parses simulation_*.txt logs into structured data
2. **Assets/Scripts/Replay/ReplayStateReconstructor.cs** - Rebuilds GameState from log initialization data
3. **Assets/Scripts/Replay/ReplayManager.cs** - Orchestrates replay playback and animation
4. **Assets/Scripts/Replay/ReplayControlsUI.cs** - UI controls for replay (pause/speed/progress)

### Modified Files

1. **Assets/Scripts/Core/GameState.cs** - Added `Replay` phase to GamePhase enum
2. **Assets/Scripts/UI/MainMenuUI.cs** - Added "Replay Latest Simulation" button and handler

## How It Works

1. User clicks "Replay Latest Simulation" button in main menu
2. System finds most recent simulation_*.txt file in project root
3. SimulationLogParser parses the log file:
   - Extracts header info (timestamp, players, max turns)
   - Parses [INIT] lines for map seed, starting units/structures
   - Parses each turn's [EVENT] lines
4. ReplayStateReconstructor rebuilds initial GameState:
   - Creates players with correct IDs and gold
   - Generates map from seed (deterministic)
   - Creates structures and units at logged positions
5. ReplayManager starts playback:
   - Iterates through turns
   - Feeds events to TurnAnimator
   - Updates GameState
   - Triggers rendering via OnStateUpdated event
6. ReplayControlsUI provides controls:
   - Pause/Resume
   - Speed control (0.5x, 1x, 2x, 5x, 10x)
   - Turn progress display
   - Exit to main menu

## Testing Procedure

### Phase 1: Basic Loading

1. **Start Unity Editor**
   - Open the project
   - Wait for compilation to complete
   - Check Console for compilation errors

2. **Generate a Simulation**
   - Play the scene
   - Click "Run AI Simulation (4 AI, 100 turns)"
   - Wait for simulation to complete
   - Verify simulation_*.txt file created in project root
   - Stop playback

3. **Test Replay Button Visibility**
   - Play the scene again
   - Verify "Replay Latest Simulation" button appears in main menu
   - Button should be between "Run AI Simulation" and "Host Game"

4. **Test No Simulation File Case**
   - Temporarily rename all simulation_*.txt files
   - Click "Replay Latest Simulation"
   - Verify message: "No simulation logs found. Run a simulation first!"
   - Restore simulation files

### Phase 2: Replay Loading

1. **Test Basic Replay Start**
   - Click "Replay Latest Simulation"
   - Watch Console for debug output:
     - `[MainMenuUI] Loading replay: ...`
     - `[SimulationLogParser] Parsing log file: ...`
     - `[SimulationLogParser] Parsing complete: ...`
     - `[ReplayStateReconstructor] Reconstructing initial game state...`
     - `[ReplayManager] Starting replay from: ...`
   - Verify no exceptions or errors

2. **Test Initial State Rendering**
   - Replay should start with map visible
   - Verify 4 starting shipyards appear (one per player)
   - Verify 4 starting ships appear (one per player)
   - Map should be the same as generated by the simulation seed

3. **Test Replay Controls UI**
   - Verify ReplayControlsUI appears at top of screen
   - Should show:
     - Title: "REPLAY MODE"
     - Turn counter: "Turn 0/X"
     - Progress bar (empty at start)
     - Pause button: "|| Pause"
     - Speed buttons: 0.5x, 1x, 2x, 5x, 10x (1x highlighted)
     - Exit button: "Exit to Main Menu"

### Phase 3: Playback Control

1. **Test Normal Playback (1x speed)**
   - Let replay run for 10-20 turns
   - Verify turn counter updates: "Turn 10/100"
   - Verify progress bar fills proportionally
   - Watch Console for turn progression logs

2. **Test Pause/Resume**
   - Click "|| Pause" button
   - Verify button text changes to "▶ Resume"
   - Verify playback stops (turn counter freezes)
   - Click "▶ Resume"
   - Verify button text changes back to "|| Pause"
   - Verify playback continues

3. **Test Speed Controls**
   - Click "2x" button
   - Verify button highlights (darker blue)
   - Verify playback speeds up (check turn counter)
   - Click "5x" button
   - Verify even faster playback
   - Click "0.5x" button
   - Verify slower playback
   - Click "10x" button
   - Verify very fast playback

4. **Test Speed During Pause**
   - Pause the replay
   - Change speed to 5x
   - Resume
   - Verify speed change takes effect

### Phase 4: Animation Verification

**Note:** Current simulation logs only contain CollisionDetected/CollisionNeedsResolution events. These are currently skipped in the parser because TurnAnimator logs them but doesn't animate them. To test full animation, we need to:

1. **Check for Missing Events**
   - Open a simulation_*.txt file
   - Search for [EVENT] lines
   - Current logs only have: CollisionDetected, CollisionNeedsResolution
   - **Expected future events:** UnitMoved, CombatOccurred, ShipBuilt, etc.

2. **Identify Why Events Are Missing**
   - Check GameSimulator.cs to see if it's logging all events
   - If not, GameSimulator needs to log more event types
   - Parser is ready to handle more event types (needs implementation)

3. **Test What Currently Happens**
   - Replay should advance through turns quickly (no animations)
   - State should update (though nothing visually changes since no movement/combat)
   - This is EXPECTED with current logs

### Phase 5: Completion and Exit

1. **Test Replay Completion**
   - Let replay run to completion (turn 100)
   - Verify turn counter shows: "Replay Complete! (100 turns)"
   - Verify text turns green
   - Verify OnReplayComplete event fires (check Console)

2. **Test Exit Button (Mid-Replay)**
   - Start a new replay
   - Let it run to turn 20
   - Click "Exit to Main Menu"
   - Verify:
     - Replay stops
     - ReplayManager destroyed
     - ReplayControlsUI destroyed
     - Main menu reappears
     - No exceptions

3. **Test Exit Button (After Completion)**
   - Let replay complete
   - Click "Exit to Main Menu"
   - Verify clean transition back to menu

### Phase 6: Edge Cases

1. **Test Multiple Replays in Succession**
   - Start a replay
   - Exit at turn 20
   - Start another replay
   - Verify no memory leaks or duplicate objects

2. **Test Corrupted Log File**
   - Create a test log file with invalid content
   - Try to replay it
   - Verify graceful error handling (check Console)

3. **Test Very Long Log**
   - If you have a 100+ turn log, replay it
   - Verify performance remains acceptable
   - Check memory usage

## Expected Issues

Based on the current simulation logs, the replay system will likely reveal:

1. **Missing Event Logging** - GameSimulator doesn't log UnitMoved, CombatOccurred, ShipBuilt events
2. **No Visual Animation** - Since events aren't logged, TurnAnimator has nothing to animate
3. **Fast Playback** - Without animations, turns advance very quickly

## Next Steps After Testing

1. **Enhance GameSimulator Logging**
   - Add logging for all GameEvent types
   - Ensure events match what TurnAnimator expects

2. **Expand Parser Event Handling**
   - Add parsing for UnitMoved events (extract paths)
   - Add parsing for CombatOccurred events (extract damage, rolls)
   - Add parsing for ShipBuilt events

3. **Test Full Animation Loop**
   - Generate new simulation with enhanced logging
   - Replay should show full animations
   - Validate timing and visual quality

4. **Polish UI**
   - Add turn seeking (slider)
   - Add event filtering options
   - Add replay speed indicator

## Success Criteria

✅ Replay button appears in main menu
✅ Latest simulation file is automatically detected
✅ Log parsing completes without errors
✅ Initial state reconstruction matches log
✅ Map renders correctly from seed
✅ Units and structures appear at correct positions
✅ Replay controls UI displays correctly
✅ Pause/resume functionality works
✅ Speed control works (0.5x - 10x)
✅ Turn counter and progress bar update
✅ Exit to main menu works cleanly
⏳ Events animate (pending GameSimulator logging enhancement)
⏳ Combat displays correctly (pending event logging)
⏳ Ship construction spawns units (pending event logging)

## Known Limitations

1. **Current logs have no movement/combat events** - This is expected, needs GameSimulator update
2. **No turn seeking** - Cannot jump to specific turn (future enhancement)
3. **No camera controls during replay** - Camera is static (could add in future)
4. **No state verification** - Doesn't compare replay state to log's [STATE_END] (future enhancement)

## Debug Console Output Guide

When testing, watch for these log patterns:

### Successful Start:
```
[MainMenuUI] Loading replay: simulation_20260131_100740.txt
[SimulationLogParser] Parsing log file: ...
[SimulationLogParser] Starting turn 0
[SimulationLogParser] Parsing complete:
  - Players: 4
  - Max Turns: 100
  - Map Seed: 1422280554
  - Turns parsed: 101
[ReplayStateReconstructor] Reconstructing initial game state...
[ReplayStateReconstructor] Created player 0: AI 0 with 100g
[ReplayStateReconstructor] Map seed: 1422280554
[ReplayManager] Starting replay from: ...
[ReplayManager] Triggering initial state render
```

### Successful Playback:
```
[ReplayManager] Starting playback coroutine
[ReplayManager] Playing turn 0/101
[ReplayManager] No events to animate for turn 0
[ReplayManager] Playing turn 1/101
...
```

### Successful Completion:
```
[ReplayManager] Playing turn 100/101
[ReplayManager] Replay complete!
[ReplayControlsUI] Replay complete!
```

## Troubleshooting

### Issue: No replay button visible
- Check MainMenuUI.cs compiled successfully
- Verify button position Y coordinates don't overlap

### Issue: "No simulation logs found"
- Verify simulation_*.txt files exist in project root (not Build folder)
- Check file permissions

### Issue: Parsing errors
- Check simulation log format matches expected patterns
- Look for malformed [INIT] or [EVENT] lines

### Issue: No map/units visible
- Check OnStateUpdated event is connected to GameManager
- Verify rendering systems are initialized
- Check Console for rendering errors

### Issue: Playback doesn't advance
- Check if coroutine started (Console log)
- Verify no exceptions stopping execution
- Check if isPaused is stuck true

### Issue: Speed control not working
- Verify TurnAnimator is initialized
- Check if timing values are being updated (Console log)
- Verify speedMultiplier is applied correctly
